(()=>{var t={n:o=>{var a=o&&o.__esModule?()=>o.default:()=>o;return t.d(a,{a}),a},d:(o,a)=>{for(var r in a)t.o(a,r)&&!t.o(o,r)&&Object.defineProperty(o,r,{enumerable:!0,get:a[r]})},o:(t,o)=>Object.prototype.hasOwnProperty.call(t,o),r:t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})}},o={};(()=>{"use strict";t.r(o),t.d(o,{extend:()=>H});const a=flarum.core.compat["common/app"];t.n(a)().initializers.add("ianm/twofactor",(function(){}));const r=flarum.core.compat["forum/app"];var n=t.n(r);const e=flarum.core.compat["common/extend"],i=flarum.core.compat["forum/components/UserSecurityPage"];var s=t.n(i);function c(t,o){return c=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,o){return t.__proto__=o,t},c(t,o)}function l(t,o){t.prototype=Object.create(o.prototype),t.prototype.constructor=t,c(t,o)}const u=flarum.core.compat["common/Component"];var d=t.n(u);const f=flarum.core.compat["common/components/Button"];var p=t.n(f);const h=flarum.core.compat["common/utils/ItemList"];var b=t.n(h);const w=flarum.core.compat["common/helpers/listItems"];var v=t.n(w);const y=flarum.core.compat["common/helpers/icon"];var _=t.n(y),g=function(t){function o(){return t.apply(this,arguments)||this}return l(o,t),o.prototype.view=function(){var t=this.attrs,o=t.icon,a=t.title,r=t.value,n=t.action,e=t.helpText;return m("li",{className:"TwoFactorGrid-item"},m("span",{className:"TwoFactorGrid-icon"},_()(o)),m("div",{className:"TwoFactorGrid-content"},m("span",{className:"TwoFactorGrid-title"},a),m("span",{className:"TwoFactorGrid-value"},r),e&&m("span",{className:"helpText TwoFactorGrid-helpText"},e)),n&&m("span",{className:"TwoFactorGrid-actions"},n))},o}(d());const F=flarum.core.compat["common/components/Tooltip"];var T=t.n(F);const k=flarum.core.compat["common/components/Modal"];var N=t.n(k);const E=flarum.core.compat["common/utils/Stream"];var q=t.n(E);const C=flarum.core.compat["common/components/LoadingIndicator"];var x=t.n(C),B=function(t){function o(){for(var o,a=arguments.length,r=new Array(a),n=0;n<a;n++)r[n]=arguments[n];return(o=t.call.apply(t,[this].concat(r))||this).user=void 0,o.status="loading",o.qrCodeUrl=null,o.backupCodes=[],o.token=void 0,o.code=null,o.activeTab="qrcode",o.loading=!1,o}l(o,t);var a=o.prototype;return a.oninit=function(a){t.prototype.oninit.call(this,a),this.user=this.attrs.user,this.token=q()(""),this.attrs.forced&&(o.isDismissibleViaCloseButton=!1,o.isDismissibleViaEscKey=!1,o.isDismissibleViaBackdropClick=!1)},a.className=function(){return"TwoFactorEnableModal Modal--small"},a.title=function(){return n().translator.trans("ianm-twofactor.forum.security.two_factor_heading")},a.oncreate=function(o){var a=this;t.prototype.oncreate.call(this,o);var r=this.user.id();n().request({method:"GET",url:n().forum.attribute("apiUrl")+"/users/"+r+"/twofactor/qrcode"}).then((function(t){a.qrCodeUrl=t.svg,a.code=t.code,a.status="displayQR",m.redraw()}))},a.onupdate=function(){var t=document.querySelector(".TwoFactorEnableModal [name=token]");t&&document.activeElement!==t&&t.focus()},a.content=function(){var t=this;return m("div",{className:"Modal-body"},"loading"===this.status&&m("div",{className:"loading"},m(x(),null),m("p",null,n().translator.trans("ianm-twofactor.forum.security.loading_qr"))),"displayQR"===this.status&&m("div",null,this.attrs.forced&&m("div",null,m("p",null,n().translator.trans("ianm-twofactor.forum.user_2fa.alert_message"))),m("div",{className:"tabs"},m(p(),{className:"qrcode"===this.activeTab?"active":"",onclick:function(){t.activeTab="qrcode",m.redraw()}},n().translator.trans("ianm-twofactor.forum.security.qr_tab")),m(p(),{className:"manual"===this.activeTab?"active":"",onclick:function(){t.activeTab="manual",m.redraw()}},n().translator.trans("ianm-twofactor.forum.security.manual_tab"))),"qrcode"===this.activeTab&&m("div",{className:"qrSection"},m("img",{className:"qrImage",src:this.qrCodeUrl,alt:n().translator.trans("ianm-twofactor.forum.security.qr_code_alt")}),m("p",{className:"helpText"},n().translator.trans("ianm-twofactor.forum.security.scan_qr_instruction"))),"manual"===this.activeTab&&m("div",{className:"manualEntrySection"},m("code",{className:"manualEntryCode"},this.code),m("p",{className:"helpText"},n().translator.trans("ianm-twofactor.forum.security.manual_entry_instruction"))),m("div",{className:"Form"},m("form",{onsubmit:this.onSubmit.bind(this)},m("div",{className:"Form-group"},m("input",{type:"text",className:"FormControl",name:"token",bidi:this.token,placeholder:n().translator.trans("ianm-twofactor.forum.security.enter_token"),inputmode:"numeric",pattern:"[0-9]*",autocomplete:"one-time-code"})),m("div",{className:"Form-group"},m(p(),{type:"submit",className:"Button Button--primary",onclick:this.verifyToken.bind(this),loading:this.loading},n().translator.trans("ianm-twofactor.forum.security.verify_button")))))),"displayBackupCodes"===this.status&&m("div",null,m("p",null,n().translator.trans("ianm-twofactor.forum.security.backup_codes")),m("ul",null,this.backupCodes.map((function(t){return m("li",null,m("code",null,t))}))),m("p",null,n().translator.trans("ianm-twofactor.forum.security.backup_codes_instruction")),m(p(),{className:"Button Button--primary",onclick:function(){t.status="final",m.redraw()}},n().translator.trans("ianm-twofactor.forum.security.saved_backup_codes_button"))),"final"===this.status&&m("div",null,m("p",null,n().translator.trans("ianm-twofactor.forum.security.two_factor_enabled_confirmation")),m(p(),{className:"Button Button--primary",onclick:this.finish.bind(this)},n().translator.trans("ianm-twofactor.forum.security.ok_button"))))},a.verifyToken=function(){var t=this;this.loading=!0,n().request({method:"POST",url:n().forum.attribute("apiUrl")+"/users/twofactor/verify",body:{token:this.token()}}).then((function(o){var a=o.backupCodes;t.backupCodes=a,t.status="displayBackupCodes",m.redraw()})).catch((function(t){})).finally((function(){t.loading=!1}))},a.finish=function(){var t,o;null==(t=(o=this.attrs).onEnabled)||t.call(o),this.hide()},a.onSubmit=function(t){t.preventDefault(),this.verifyToken()},o}(N());B.isDismissibleViaCloseButton=!0,B.isDismissibleViaEscKey=!0,B.isDismissibleViaBackdropClick=!0;var D=function(t){function o(){return t.apply(this,arguments)||this}l(o,t);var a=o.prototype;return a.oninit=function(o){t.prototype.oninit.call(this,o),this.loading=!1},a.className=function(){return"TwoFactorDisableConfirmModal Modal--small"},a.title=function(){return n().translator.trans("ianm-twofactor.forum.security.confirm_disable_2fa_title")},a.content=function(){return m("div",{className:"Modal-body"},m("p",null,n().translator.trans("ianm-twofactor.forum.security.confirm_disable_2fa_text")),m("div",{className:"Form-group"},m(p(),{className:"Button Button--danger",onclick:this.disable.bind(this),loading:this.loading},n().translator.trans("ianm-twofactor.forum.security.disable_2fa_button")),m(p(),{className:"Button Button--cancel",onclick:this.hide.bind(this)},n().translator.trans("ianm-twofactor.forum.security.cancel_button"))))},a.disable=function(){var t=this;this.loading=!0;var o=this.attrs.user.id();n().request({method:"DELETE",url:n().forum.attribute("apiUrl")+"/users/"+o+"/twofactor/disable"}).then((function(){t.loading=!1,t.attrs.onDisabled(),t.hide()})).catch((function(t){}))},o}(N()),A=function(t){function o(){for(var o,a=arguments.length,r=new Array(a),n=0;n<a;n++)r[n]=arguments[n];return(o=t.call.apply(t,[this].concat(r))||this).user=void 0,o.twoFactorEnabled=void 0,o.canDisableTwoFactor=void 0,o.backupCodesRemaining=void 0,o}l(o,t);var a=o.prototype;return a.oninit=function(o){t.prototype.oninit.call(this,o),this.user=this.attrs.user,this.twoFactorEnabled=this.user.twoFactorEnabled(),this.canDisableTwoFactor=this.user.canDisable2FA(),this.backupCodesRemaining=this.user.backupCodesRemaining()||0},a.view=function(){return m("div",{className:"TwoFactorGrid"},m("ul",null,v()(this.twoFactorItems().toArray())))},a.twoFactorItems=function(){var t=new(b()),o=this.getDisableAction(),a=m(p(),{className:"Button Button--primary",onclick:this.enableTwoFactor.bind(this)},n().translator.trans("ianm-twofactor.forum.security.enable_2fa_button"));return t.add("status",m(g,{icon:"fas fa-shield-alt",title:n().translator.trans("ianm-twofactor.forum.security.two_factor_title"),value:this.twoFactorEnabled?n().translator.trans("ianm-twofactor.forum.security.two_factor_enabled"):n().translator.trans("ianm-twofactor.forum.security.two_factor_disabled"),action:this.twoFactorEnabled?o:a,helpText:!this.canDisableTwoFactor&&n().translator.trans("ianm-twofactor.forum.security.cannot_disable")})),this.twoFactorEnabled?(t.add("backupCodes",m(g,{icon:"fas fa-key",title:n().translator.trans("ianm-twofactor.forum.security.backup_codes_remaining"),value:this.backupCodesRemaining})),t):t},a.getDisableAction=function(){var t=m(p(),{className:"Button Button--danger",onclick:this.disableTwoFactor.bind(this),disabled:!this.canDisableTwoFactor},n().translator.trans("ianm-twofactor.forum.security.disable_2fa_button"));return this.canDisableTwoFactor?t:m(T(),{text:n().translator.trans("ianm-twofactor.forum.security.cannot_disable_tooltip")},t)},a.enableTwoFactor=function(){n().modal.show(B,{onEnabled:this.onTwoFactorEnabled.bind(this),user:this.user})},a.onTwoFactorEnabled=function(){this.twoFactorEnabled=!0,m.redraw()},a.disableTwoFactor=function(){n().modal.show(D,{onDisabled:this.onTwoFactorDisabled.bind(this),user:this.user})},a.onTwoFactorDisabled=function(){this.twoFactorEnabled=!1,m.redraw()},a.generateBackupCodes=function(){m.redraw()},o}(d()),M=function(t){function o(){return t.apply(this,arguments)||this}l(o,t);var a=o.prototype;return a.oninit=function(o){t.prototype.oninit.call(this,o)},a.view=function(){return m("div",null,m(A,{user:this.attrs.user}))},o}(d());const S=flarum.core.compat["common/components/FieldSet"];var R=t.n(S);const G=flarum.core.compat["common/components/LinkButton"];var O=t.n(G);const P=flarum.core.compat["forum/components/LogInModal"];var I=t.n(P);const U=flarum.core.compat["common/extenders"];var j=t.n(U);const V=flarum.core.compat["common/models/Group"];var L=t.n(V);const z=flarum.core.compat["common/models/User"];var K=t.n(z);const Q=[new(j().Model)(K()).attribute("twoFactorEnabled").attribute("canDisable2FA").attribute("mustEnable2FA").attribute("backupCodesRemaining"),new(j().Model)(L()).attribute("requires2FA")],H=[].concat(Q);n().initializers.add("ianm/twofactor",(function(){(0,e.extend)(s().prototype,"settingsItems",(function(t){t.add("twoFactor",m(R(),{label:n().translator.trans("ianm-twofactor.forum.security.two_factor_heading")},m("p",{className:"helpText"},n().translator.trans("ianm-twofactor.forum.security.two_factor_help")),m("p",{className:"helpText"},n().translator.trans("ianm-twofactor.forum.security.two_factor_apps",{google:m(O(),{external:!0,href:"https://play.google.com/store/apps/details?id=com.google.android.apps.authenticator2",target:"_blank",rel:"noopener noreferrer"},"Google Authenticator"),microsoft:m(O(),{external:!0,href:"https://www.microsoft.com/en-us/account/authenticator",target:"_blank",rel:"noopener noreferrer"},"Microsoft Authenticator"),authy:m(O(),{external:!0,href:"https://authy.com/download/",target:"_blank",rel:"noopener noreferrer"},"Authy")})),m(M,{user:this.user})),100)})),(0,e.extend)(I().prototype,"oninit",(function(t){this.twoFactorToken=q()(""),this.twoFactorRequired=!1})),(0,e.extend)(I().prototype,"fields",(function(t){var o=this;this.twoFactorRequired&&(t.add("twoFactor",m("div",{className:"Form-group TwoFactorInput"},m("legend",null,n().translator.trans("ianm-twofactor.forum.log_in.two_factor_required_message")),m("input",{className:"FormControl",name:"twoFactorToken",type:"text",placeholder:n().translator.trans("ianm-twofactor.forum.log_in.two_factor_placeholder"),value:this.twoFactorToken(),disabled:this.loading,inputmode:"numeric",pattern:"[0-9]*",autocomplete:"one-time-code",oninput:function(t){o.twoFactorToken(t.currentTarget.value),6===t.target.value.length&&o.onsubmit(new Event("submit"))}})),19),t.remove("identification"),t.remove("password"),t.remove("remember"))})),(0,e.extend)(I().prototype,"loginParams",(function(t){return t.twoFactorToken=this.twoFactorToken(),t})),(0,e.override)(I().prototype,"body",(function(t){return this.twoFactorRequired?m("div",{className:"Form Form--centered"},this.fields().toArray()):t()})),(0,e.override)(I().prototype,"footer",(function(t){return this.twoFactorRequired?m("div",null):t()})),(0,e.override)(I().prototype,"onerror",(function(t,o){if(422===o.status){var a=o.response&&o.response.errors;(a&&a[0]&&a[0].detail||"").includes("two_factor_required")?this.twoFactorRequired=!0:(o.alert.content=n().translator.trans("core.forum.log_in.invalid_login_message"),this.alertAttrs=o.alert),m.redraw(),this.onready()}else t(o)})),new Promise((function(){setTimeout((function(){var t;null!=(t=n().session.user)&&t.mustEnable2FA()&&n().modal.show(B,{user:n().session.user,forced:!0})}),300)}))}))})(),module.exports=o})();
//# sourceMappingURL=forum.js.map